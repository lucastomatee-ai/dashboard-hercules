<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard LATAM - Protocolo Hercules</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Syne:wght@700;800;900&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #03050f;
            color: #fff;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 1600px; margin: 0 auto; }

        /* ‚îÄ‚îÄ PALETA AZUL ‚îÄ‚îÄ */
        :root {
            --primary: #1a6bff;
            --primary-dark: #0d3d99;
            --primary-glow: rgba(26, 107, 255, 0.4);
            --primary-dim: rgba(26, 107, 255, 0.15);
            --primary-border: rgba(26, 107, 255, 0.5);
            --green: #00e5a0;
            --green-dim: rgba(0, 229, 160, 0.12);
            --yellow: #ffc940;
            --yellow-dim: rgba(255, 201, 64, 0.15);
            --red: #ff4060;
            --bg-card: #080c1a;
            --bg-card2: #0b1020;
            --border: rgba(26, 107, 255, 0.18);
        }

        /* scanline overlay */
        body::before {
            content: '';
            position: fixed; inset: 0;
            background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.025) 2px, rgba(0,0,0,0.025) 4px);
            pointer-events: none; z-index: 0;
        }

        /* ‚îÄ‚îÄ ALERTAS ‚îÄ‚îÄ */
        .alerts-container {
            position: fixed;
            top: 20px; right: 20px;
            z-index: 9999;
            max-width: 350px;
        }
        .alert-item {
            background: linear-gradient(135deg, #080c1a 0%, #001133 100%);
            border: 2px solid var(--green);
            border-radius: 12px;
            padding: 15px 20px;
            margin-bottom: 10px;
            box-shadow: 0 0 30px rgba(0, 229, 160, 0.5);
            animation: slideInRight 0.5s ease;
            cursor: pointer;
            position: relative;
        }
        .alert-item.checkout { border-color: var(--green); box-shadow: 0 0 30px rgba(0,229,160,0.5); }
        .alert-item.sale { border-color: var(--yellow); box-shadow: 0 0 30px rgba(255,201,64,0.5); }
        @keyframes slideInRight { from { transform: translateX(400px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { to { opacity: 0; transform: translateX(400px); } }
        .alert-title { font-size: 14px; font-weight: 900; color: var(--green); margin-bottom: 5px; text-transform: uppercase; font-family: 'Syne', sans-serif; }
        .alert-item.sale .alert-title { color: var(--yellow); }
        .alert-message { font-size: 13px; color: #ccc; line-height: 1.4; }
        .alert-close { position: absolute; top: 10px; right: 10px; color: #999; cursor: pointer; font-size: 18px; line-height: 1; }
        .alert-close:hover { color: #fff; }

        /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
        .header {
            background: linear-gradient(135deg, #080c1a 0%, #001033 100%);
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 0 30px var(--primary-glow);
        }
        .title {
            font-family: 'Syne', sans-serif;
            font-size: 32px; font-weight: 900;
            color: #4d9fff;
            margin-bottom: 8px;
            text-shadow: 0 0 20px rgba(77, 159, 255, 0.5);
        }
        .subtitle { color: #aaa; font-size: 14px; font-weight: 500; }

        /* ‚îÄ‚îÄ ONLINE BADGE ‚îÄ‚îÄ */
        .online-badge {
            background: var(--primary-dim);
            border: 2px solid var(--primary);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 0 20px var(--primary-glow);
        }
        .online-label { color: #ccc; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .online-count {
            font-family: 'Syne', sans-serif;
            font-size: 56px; font-weight: 900;
            color: #4d9fff;
            text-shadow: 0 0 30px rgba(77, 159, 255, 0.6);
            animation: pulseBlue 2s ease-in-out infinite;
        }
        @keyframes pulseBlue { 0%,100%{opacity:1;} 50%{opacity:0.75;} }

        /* ‚îÄ‚îÄ COMPARA√á√ÉO DE PER√çODOS ‚îÄ‚îÄ */
        .comparison-section {
            background: linear-gradient(135deg, #080c1a 0%, #001033 100%);
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 0 20px rgba(26,107,255,0.2);
        }
        .comparison-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px; }
        .comparison-card {
            background: rgba(0,0,0,0.5);
            border: 2px solid #333;
            border-radius: 12px;
            padding: 20px;
        }
        .comparison-card.winner { border-color: var(--green); background: rgba(0,229,160,0.05); }
        .comparison-card.loser  { border-color: var(--red); background: rgba(255,64,96,0.05); }
        .comparison-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .comparison-period { font-size: 12px; font-weight: 800; color: #999; text-transform: uppercase; }
        .comparison-badge { font-size: 10px; font-weight: 900; padding: 4px 10px; border-radius: 20px; text-transform: uppercase; }
        .comparison-badge.up { background: var(--green); color: #000; }
        .comparison-badge.down { background: var(--red); color: #fff; }
        .comparison-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.08); }
        .comparison-label { color: #999; font-size: 12px; font-weight: 600; }
        .comparison-value { color: #fff; font-size: 14px; font-weight: 800; }
        .comparison-diff { display: flex; align-items: center; gap: 5px; font-size: 11px; font-weight: 700; }
        .comparison-diff.positive { color: var(--green); }
        .comparison-diff.negative { color: var(--red); }
        .comparison-selector { display: flex; gap: 10px; margin-bottom: 20px; }
        .comparison-select {
            flex: 1; background: rgba(0,0,0,0.5); border: 1px solid #444;
            color: #fff; padding: 10px 15px; border-radius: 8px;
            font-size: 13px; font-weight: 600; cursor: pointer;
        }

        /* ‚îÄ‚îÄ FILTROS COMPACTOS ‚îÄ‚îÄ */
        .compact-filters { display: flex; gap: 6px; align-items: center; }
        .compact-filter-btn {
            background: rgba(0,0,0,0.3); border: 1px solid #444; color: #999;
            padding: 4px 12px; border-radius: 4px; cursor: pointer;
            font-size: 11px; font-weight: 600; transition: all 0.2s;
        }
        .compact-filter-btn:hover { background: var(--primary-dim); border-color: var(--primary); color: #4d9fff; }
        .compact-filter-btn.active { background: var(--primary-dim); border-color: var(--primary); color: #4d9fff; }
        .compact-date-input {
            background: rgba(0,0,0,0.3); border: 1px solid #444; color: #999;
            padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;
            cursor: pointer; width: 110px;
        }
        .compact-date-input::-webkit-calendar-picker-indicator { filter: invert(0.6); cursor: pointer; }

        /* ‚îÄ‚îÄ SE√á√ïES GERAIS ‚îÄ‚îÄ */
        .stats-section {
            background: linear-gradient(135deg, #080c1a 0%, #001033 100%);
            border: 2px solid var(--primary);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 0 20px rgba(26,107,255,0.2);
        }
        .section-title {
            font-family: 'Syne', sans-serif;
            color: #4d9fff;
            font-size: 14px; font-weight: 800;
            text-transform: uppercase; letter-spacing: 1.5px;
            margin-bottom: 20px;
            display: flex; align-items: center; gap: 8px;
            text-shadow: 0 0 10px rgba(77,159,255,0.3);
        }

        /* ‚îÄ‚îÄ STAT CARDS ‚îÄ‚îÄ */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .stat-card {
            background: rgba(0,0,0,0.5);
            border: 2px solid #1e2a44;
            border-radius: 8px; padding: 20px; text-align: center;
            transition: all 0.3s;
        }
        .stat-card:hover { border-color: var(--primary); box-shadow: 0 0 15px var(--primary-glow); }
        .stat-card.highlight {
            background: linear-gradient(135deg, rgba(0,229,160,0.1) 0%, rgba(0,200,140,0.05) 100%);
            border: 2px solid var(--green);
            animation: pulseGreen 2s ease-in-out infinite;
        }
        .stat-card.highlight:hover { box-shadow: 0 0 25px rgba(0,229,160,0.5); }
        .stat-card.highlight .stat-value { color: var(--green); text-shadow: 0 0 20px rgba(0,229,160,0.5); }
        @keyframes pulseGreen { 0%,100%{box-shadow:0 0 15px rgba(0,229,160,0.3);} 50%{box-shadow:0 0 30px rgba(0,229,160,0.6);} }
        .stat-label { color: #999; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 10px; }
        .stat-value { color: #fff; font-size: 36px; font-weight: 900; margin-bottom: 5px; font-family: 'Syne', sans-serif; }
        .stat-percent { color: #4d9fff; font-size: 13px; font-weight: 600; }

        /* ‚îÄ‚îÄ MAIN GRID ‚îÄ‚îÄ */
        .main-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }

        /* ‚îÄ‚îÄ FUNIL ‚îÄ‚îÄ */
        .funnel-stage {
            background: linear-gradient(135deg, var(--primary-dim) 0%, rgba(26,107,255,0.05) 100%);
            border: 2px solid var(--primary);
            border-radius: 8px; padding: 15px; margin-bottom: 10px;
            position: relative; transition: all 0.3s;
        }
        .funnel-stage:hover { background: rgba(26,107,255,0.25); box-shadow: 0 0 15px var(--primary-glow); }
        .funnel-stage-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .funnel-stage-name { font-size: 13px; font-weight: 700; color: #fff; text-transform: uppercase; }
        .funnel-stage-count { font-size: 18px; font-weight: 900; color: #4d9fff; font-family: 'Syne', sans-serif; }
        .funnel-stage-bar { width: 100%; height: 8px; background: rgba(0,0,0,0.5); border-radius: 4px; overflow: hidden; margin-bottom: 5px; }
        .funnel-stage-fill { height: 100%; background: linear-gradient(90deg, var(--primary-dark) 0%, #4d9fff 100%); transition: width 0.5s ease; }
        .funnel-stage-percent { font-size: 11px; color: #999; font-weight: 600; }
        .funnel-arrow { text-align: center; font-size: 18px; color: var(--primary); margin: -5px 0; }

        /* ‚îÄ‚îÄ HEATMAP ‚îÄ‚îÄ */
        .heatmap-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        .heatmap-table th, .heatmap-table td { padding: 12px 8px; text-align: center; font-size: 12px; font-weight: 600; border: 1px solid rgba(26,107,255,0.2); }
        .heatmap-table th { background: var(--primary-dim); color: #4d9fff; font-weight: 800; text-transform: uppercase; font-size: 11px; }
        .heatmap-table .day-label { background: var(--primary-dim); color: #fff; font-weight: 700; text-align: left; padding-left: 15px; }
        .heatmap-cell { position: relative; cursor: pointer; transition: all 0.3s; }
        .heatmap-cell:hover { transform: scale(1.1); box-shadow: 0 0 15px rgba(255,255,255,0.3); }
        .heatmap-cell.high   { background: rgba(0,229,160,0.6); color: #000; font-weight: 900; }
        .heatmap-cell.medium { background: rgba(255,201,64,0.6); color: #000; font-weight: 900; }
        .heatmap-cell.low    { background: rgba(255,64,96,0.6); color: #fff; font-weight: 900; }
        .heatmap-cell.empty  { background: rgba(0,0,0,0.3); color: #666; }
        .heatmap-legend { display: flex; gap: 20px; justify-content: center; margin-top: 15px; padding: 10px; font-size: 11px; }
        .heatmap-legend-item { display: flex; align-items: center; gap: 8px; }
        .heatmap-legend-color { width: 20px; height: 20px; border-radius: 4px; }

        /* ‚îÄ‚îÄ CHART CONTAINERS ‚îÄ‚îÄ */
        .chart-and-retention { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
        .chart-container { background: linear-gradient(135deg, #080c1a 0%, #001033 100%); border: 2px solid var(--primary); border-radius: 12px; padding: 25px; box-shadow: 0 0 20px rgba(26,107,255,0.2); }
        .chart-wrapper { position: relative; height: 300px; margin-top: 20px; }

        /* ‚îÄ‚îÄ QUIZ RETENTION ‚îÄ‚îÄ */
        .quiz-retention { background: linear-gradient(135deg, #080c1a 0%, #001033 100%); border: 2px solid var(--primary); border-radius: 12px; padding: 25px; box-shadow: 0 0 20px rgba(26,107,255,0.2); }
        .quiz-stats { display: grid; gap: 8px; max-height: 340px; overflow-y: auto; }
        .quiz-row { background: rgba(0,0,0,0.5); border-left: 4px solid var(--primary); padding: 10px 15px; border-radius: 6px; display: flex; justify-content: space-between; align-items: center; transition: all 0.3s; font-size: 12px; }
        .quiz-row:hover { background: var(--primary-dim); box-shadow: 0 0 15px var(--primary-glow); }
        .quiz-step { color: #fff; font-weight: 600; }
        .quiz-count { color: #4d9fff; font-size: 14px; font-weight: 800; font-family: 'Syne', sans-serif; }

        /* ‚îÄ‚îÄ SPY ‚îÄ‚îÄ */
        .spy-section-title { font-family: 'Syne', sans-serif; color: #4d9fff; font-size: 14px; font-weight: 800; text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 20px; text-shadow: 0 0 10px rgba(77,159,255,0.3); }
        .spy-container { background: linear-gradient(135deg, #080c1a 0%, #001033 100%); border: 2px solid var(--primary); border-radius: 12px; padding: 20px; max-height: 600px; overflow-y: auto; box-shadow: 0 0 20px rgba(26,107,255,0.2); }
        .spy-filters { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .spy-filter-btn { background: rgba(0,0,0,0.5); border: 1px solid #444; color: #999; padding: 8px 16px; border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 700; transition: all 0.2s; }
        .spy-filter-btn:hover { border-color: var(--primary); color: #4d9fff; }
        .spy-filter-btn.active { background: var(--primary-dim); border-color: var(--primary); color: #4d9fff; }

        .spy-item {
            background: rgba(0,0,0,0.5);
            border-left: 4px solid #4d9fff;
            padding: 18px 20px; border-radius: 10px; margin-bottom: 12px;
            animation: slideInLeft 0.4s ease; transition: all 0.3s;
            display: grid; grid-template-columns: auto 1fr auto;
            gap: 15px; align-items: center;
        }
        .spy-item:hover { background: var(--primary-dim); box-shadow: 0 0 20px var(--primary-glow); transform: translateX(5px); }
        .spy-item.checkout {
            border-left: 4px solid var(--green);
            background: linear-gradient(90deg, rgba(0,229,160,0.15) 0%, rgba(0,229,160,0.05) 100%);
            box-shadow: 0 0 25px rgba(0,229,160,0.4);
            animation: checkoutPulse 0.6s ease;
        }
        .spy-item.sale {
            border-left: 4px solid var(--yellow);
            background: linear-gradient(90deg, rgba(255,201,64,0.15) 0%, rgba(255,201,64,0.05) 100%);
            box-shadow: 0 0 25px rgba(255,201,64,0.4);
        }
        @keyframes slideInLeft { from { opacity:0; transform: translateX(-30px); } to { opacity:1; transform: translateX(0); } }
        @keyframes checkoutPulse { 0%{transform:scale(0.95); box-shadow:0 0 15px rgba(0,229,160,0.2);} 50%{transform:scale(1.02); box-shadow:0 0 35px rgba(0,229,160,0.6);} 100%{transform:scale(1); box-shadow:0 0 25px rgba(0,229,160,0.4);} }

        .spy-avatar { width:45px; height:45px; border-radius:50%; background: linear-gradient(135deg, var(--primary-dark) 0%, #4d9fff 100%); display:flex; align-items:center; justify-content:center; font-weight:900; font-size:16px; color:#fff; flex-shrink:0; }
        .spy-item.checkout .spy-avatar { background: linear-gradient(135deg, #00c880 0%, var(--green) 100%); color:#000; }
        .spy-item.sale .spy-avatar { background: linear-gradient(135deg, #e6a800 0%, var(--yellow) 100%); color:#000; }

        .spy-content { flex:1; min-width:0; }
        .spy-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; }
        .spy-id { color:#fff; font-weight:800; font-size:14px; }
        .spy-time { color:#999; font-size:11px; font-weight:600; white-space:nowrap; }
        .spy-status { color:#ccc; font-size:13px; font-weight:600; line-height:1.4; }
        .spy-status.checkout { color:var(--green); font-weight:800; font-size:14px; }
        .spy-status.sale { color:var(--yellow); font-weight:800; font-size:14px; }

        /* Quiz progress dots */
        .quiz-progress-dots { display:flex; gap:4px; margin-top:6px; align-items:center; }
        .qp-dot { width:18px; height:5px; border-radius:3px; background:#1e2a44; transition:background 0.3s; }
        .qp-dot.done { background: var(--primary); }
        .qp-dot.current { background: var(--yellow); animation: pulseBlue 1s infinite; }
        .qp-label { font-size:10px; color:#999; margin-left:6px; font-weight:700; }

        .spy-badges { display:flex; flex-direction:column; gap:5px; align-items:flex-end; }
        .online-dot { display:inline-block; width:10px; height:10px; background:var(--green); border-radius:50%; animation:pulse 2s infinite; box-shadow:0 0 10px rgba(0,229,160,0.6); }
        @keyframes pulse { 0%,100%{opacity:1;transform:scale(1);} 50%{opacity:0.6;transform:scale(1.2);} }
        .checkout-badge { display:inline-block; background:var(--green); color:#000; padding:5px 12px; border-radius:6px; font-size:10px; font-weight:900; text-transform:uppercase; box-shadow:0 0 15px rgba(0,229,160,0.4); }
        .sale-badge { display:inline-block; background:linear-gradient(135deg,#e6a800,var(--yellow)); color:#000; padding:5px 12px; border-radius:6px; font-size:10px; font-weight:900; text-transform:uppercase; box-shadow:0 0 15px rgba(255,201,64,0.4); }

        /* ‚îÄ‚îÄ PA√çSES COMPACTO ‚îÄ‚îÄ */
        .countries-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
        .country-pill { background:rgba(0,0,0,0.4); border:1px solid #1e2a44; border-radius:10px; padding:10px 12px; display:flex; align-items:center; gap:10px; transition:border-color 0.3s; }
        .country-pill:hover { border-color:var(--green); }
        .country-flag { font-size:22px; flex-shrink:0; }
        .country-data { flex:1; min-width:0; }
        .country-name { font-size:11px; color:#999; }
        .country-nums { display:flex; gap:8px; margin-top:3px; align-items:baseline; }
        .country-vis { font-family:'Syne',sans-serif; font-size:16px; font-weight:800; color:#fff; }
        .country-conv { font-size:10px; color:var(--green); font-weight:700; }
        .country-rev  { font-size:10px; color:var(--yellow); }
        .country-pill.hottest { border-color:var(--primary) !important; box-shadow:0 0 12px var(--primary-glow); }

        /* ‚îÄ‚îÄ EMPTY / LOADING ‚îÄ‚îÄ */
        .empty-state { text-align:center; padding:60px 20px; color:#666; font-size:14px; }
        .loading-spinner { border:3px solid rgba(26,107,255,0.1); border-top:3px solid var(--primary); border-radius:50%; width:40px; height:40px; animation:spin 1s linear infinite; margin:0 auto 20px; }
        @keyframes spin { to{transform:rotate(360deg);} }

        ::-webkit-scrollbar { width:8px; }
        ::-webkit-scrollbar-track { background:rgba(0,0,0,0.3); }
        ::-webkit-scrollbar-thumb { background:var(--primary); border-radius:4px; }
        ::-webkit-scrollbar-thumb:hover { background:#4d9fff; }

        @media (max-width:1200px) {
            .main-grid { grid-template-columns:1fr; }
            .chart-and-retention { grid-template-columns:1fr; }
            .comparison-grid { grid-template-columns:1fr; }
        }
        @media (max-width:700px) {
            .countries-grid { grid-template-columns:repeat(2,1fr); }
        }
    </style>
</head>
<body>
<div class="container">

    <!-- ALERTAS EM TEMPO REAL -->
    <div class="alerts-container" id="alerts-container"></div>

    <!-- HEADER -->
    <div class="header">
        <div class="title">üåé PROTOCOLO HERCULES ‚Äî Dashboard LATAM</div>
        <div class="subtitle">Monitoreo en Tiempo Real ¬∑ Am√©rica Latina</div>
    </div>

    <!-- ONLINE AGORA -->
    <div class="online-badge">
        <div class="online-label">üë• Online Ahora (LATAM)</div>
        <div class="online-count" id="online-now">0</div>
    </div>

    <!-- COMPARA√á√ÉO DE PER√çODOS -->
    <div class="comparison-section">
        <div class="section-title">üìä Comparaci√≥n de Per√≠odos</div>
        <div class="comparison-selector">
            <select class="comparison-select" id="period-a" onchange="updateComparison()">
                <option value="today">Hoy</option>
                <option value="yesterday">Ayer</option>
                <option value="7days">√öltimos 7 d√≠as</option>
                <option value="30days" selected>√öltimos 30 d√≠as</option>
            </select>
            <span style="color:#999;align-self:center;font-weight:800;">VS</span>
            <select class="comparison-select" id="period-b" onchange="updateComparison()">
                <option value="today">Hoy</option>
                <option value="yesterday">Ayer</option>
                <option value="7days">√öltimos 7 d√≠as</option>
                <option value="30days">√öltimos 30 d√≠as</option>
                <option value="prev_period" selected>Per√≠odo Anterior</option>
            </select>
        </div>
        <div class="comparison-grid" id="comparison-grid"></div>
    </div>

    <!-- STATS: ACESSOS + CONVERS√ïES -->
    <div class="main-grid">
        <div class="stats-section">
            <div class="section-title">üìä Accesos (Visi√≥n Actual)</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total Accesos</div>
                    <div class="stat-value" id="total-visits">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Inici√≥ Quiz</div>
                    <div class="stat-value" id="passed-instruction">0</div>
                    <div class="stat-percent" id="passed-instruction-pct">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Complet√≥ Quiz</div>
                    <div class="stat-value" id="clicked-vsl">0</div>
                    <div class="stat-percent" id="clicked-vsl-pct">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Vio Resultado</div>
                    <div class="stat-value" id="started-quiz">0</div>
                    <div class="stat-percent" id="started-quiz-pct">0%</div>
                </div>
            </div>
        </div>
        <div class="stats-section">
            <div class="section-title">üéØ Conversiones</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Leads</div>
                    <div class="stat-value" id="total-leads">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Tasa Conclusi√≥n</div>
                    <div class="stat-value" id="completion-rate">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">En Checkout</div>
                    <div class="stat-value" id="checkout-count">0</div>
                    <div class="stat-percent" id="checkout-pct">0%</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Mayor Abandono</div>
                    <div class="stat-value" id="highest-dropout" style="font-size:18px;">--</div>
                </div>
            </div>
        </div>
    </div>

    <!-- VENTAS CONFIRMADAS -->
    <div class="stats-section" style="margin-bottom:30px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <div class="section-title" style="margin-bottom:0;">üí∞ VENTAS CONFIRMADAS (USD)</div>
            <div class="compact-filters">
                <button class="compact-filter-btn active" onclick="setDateFilter('today',event)">Hoy</button>
                <button class="compact-filter-btn" onclick="setDateFilter('yesterday',event)">Ayer</button>
                <button class="compact-filter-btn" onclick="setDateFilter('7days',event)">7d</button>
                <button class="compact-filter-btn" onclick="setDateFilter('30days',event)">30d</button>
                <button class="compact-filter-btn" onclick="setDateFilter('all',event)">Todo</button>
                <input type="date" id="date-start" class="compact-date-input"/>
                <input type="date" id="date-end" class="compact-date-input"/>
                <button class="compact-filter-btn" onclick="setCustomDateRange()">OK</button>
            </div>
        </div>
        <div class="stats-grid">
            <div class="stat-card highlight">
                <div class="stat-label">Ventas</div>
                <div class="stat-value" id="sales-today">0</div>
            </div>
            <div class="stat-card highlight">
                <div class="stat-label">Bruto</div>
                <div class="stat-value" id="revenue-today" style="font-size:24px;">$0</div>
            </div>
            <div class="stat-card highlight">
                <div class="stat-label">Tasas (15%)</div>
                <div class="stat-value" id="total-fees" style="font-size:24px;color:var(--red);">-$0</div>
            </div>
            <div class="stat-card highlight">
                <div class="stat-label">Neto</div>
                <div class="stat-value" id="net-revenue" style="font-size:24px;">$0</div>
            </div>
            <div class="stat-card highlight">
                <div class="stat-label">Tasa Conversi√≥n</div>
                <div class="stat-value" id="conversion-rate">0%</div>
            </div>
            <div class="stat-card highlight">
                <div class="stat-label">Ticket Promedio</div>
                <div class="stat-value" id="average-ticket" style="font-size:24px;">$0</div>
            </div>
            <div class="stat-card highlight">
                <div class="stat-label">Checkouts/Venta</div>
                <div class="stat-value" id="leads-per-sale" style="font-size:32px;">--</div>
            </div>
        </div>
    </div>

    <!-- GR√ÅFICO VENDAS + FUNIL -->
    <div style="display:grid;grid-template-columns:1.5fr 1fr;gap:20px;margin-bottom:30px;">
        <div class="stats-section">
            <div class="section-title">üìà Ventas a lo Largo del Tiempo</div>
            <div class="chart-wrapper" style="height:280px;">
                <canvas id="salesTimeChart"></canvas>
            </div>
        </div>
        <div class="stats-section">
            <div class="section-title">üéØ Funil de Conversi√≥n</div>
            <div id="funnel-container" style="padding:10px 0;"></div>
        </div>
    </div>

    <!-- HEATMAP -->
    <div class="stats-section" style="margin-bottom:30px;">
        <div class="section-title">üî• Mejores Horarios para Vender</div>
        <div id="heatmap-container" style="overflow-x:auto;"></div>
    </div>

    <!-- CHART PICO + QUIZ RETENTION -->
    <div class="chart-and-retention">
        <div class="chart-container">
            <div class="section-title">‚è∞ Hor√°rio de Pico (Entradas/Hora)</div>
            <div class="chart-wrapper"><canvas id="peakHourChart"></canvas></div>
        </div>
        <div class="quiz-retention">
            <div class="section-title">üìà Retenci√≥n Quiz</div>
            <div class="quiz-stats" id="quiz-stats"><div class="empty-state">Cargando...</div></div>
        </div>
    </div>

    <!-- PA√çSES COMPACTO -->
    <div class="stats-section" style="margin:30px 0;">
        <div class="section-title">üåé Accesos por Pa√≠s</div>
        <div class="countries-grid" id="countries-grid"></div>
    </div>

    <!-- SPY FEED -->
    <div>
        <div class="spy-section-title">üîµ Esp√≠a en Vivo (Tiempo Real)</div>
        <div class="spy-filters">
            <button class="spy-filter-btn active" onclick="filterSpy('all',event)">Todos</button>
            <button class="spy-filter-btn" onclick="filterSpy('online',event)">üü¢ Online</button>
            <button class="spy-filter-btn" onclick="filterSpy('checkout',event)">üí≥ Checkout</button>
            <button class="spy-filter-btn" onclick="filterSpy('sale',event)">üí∞ Ventas</button>
        </div>
        <div class="spy-container" id="spy-container">
            <div class="empty-state"><div class="loading-spinner"></div><div>Esperando leads de LATAM...</div></div>
        </div>
    </div>

</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getFirestore, collection, query, orderBy, onSnapshot } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

const app = initializeApp({
    apiKey: "AIzaSyDk4wUGAeG4uQW7Rmad59AmuzqKiOYB9vk",
    authDomain: "protocolo-hercules.firebaseapp.com",
    projectId: "protocolo-hercules",
    storageBucket: "protocolo-hercules.firebasestorage.app",
    messagingSenderId: "701694377617",
    appId: "1:701694377617:web:153290a4cd66ddaae74930"
});
const db = getFirestore(app);

let allSessions = [], allSales = [];
let peakHourChart = null, salesTimeChart = null;
let lastCheckoutIds = new Set(), lastSaleIds = new Set();
let currentDateFilter = 'today', customDateRange = null;
let spyFilter = 'all';

// ‚îÄ‚îÄ TAXAS (15% fixo para LATAM / Hotmart) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function calcFee(amount) { return amount * 0.15; }
function calcNet(amount) { return amount - calcFee(amount); }

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const isOnline = s => s.lastActivity && (Date.now() - ms(s.lastActivity)) < 120000;
const ms = t => t?.toMillis ? t.toMillis() : (t || 0);
const pct = (a,b) => b > 0 ? ((a/b)*100).toFixed(1)+'%' : '0%';
const fmt$ = v => '$'+v.toFixed(2);

function timeAgo(ts) {
    if (!ts) return 'ahora';
    const s = Math.floor((Date.now() - ms(ts)) / 1000);
    if (s < 60) return 'hace '+s+'s';
    const m = Math.floor(s/60);
    if (m < 60) return 'hace '+m+'m';
    const h = Math.floor(m/60);
    if (h < 24) return 'hace '+h+'h';
    return 'hace '+Math.floor(h/24)+'d';
}

function getFlag(c) {
    const f={MX:'üá≤üáΩ',CO:'üá®üá¥',AR:'üá¶üá∑',PE:'üáµüá™',CL:'üá®üá±',VE:'üáªüá™',EC:'üá™üá®',UY:'üá∫üáæ',PY:'üáµüáæ',BO:'üáßüá¥',GT:'üá¨üáπ',HN:'üá≠üá≥',SV:'üá∏üáª',NI:'üá≥üáÆ',CR:'üá®üá∑',PA:'üáµüá¶',DO:'üá©üá¥',CU:'üá®üá∫',BR:'üáßüá∑'};
    return f[c] || 'üåé';
}

function getDateRange(filter, refRange=null) {
    const now=new Date(), today=new Date(now.getFullYear(),now.getMonth(),now.getDate());
    if (filter==='custom' && customDateRange) return customDateRange;
    if (filter==='prev_period' && refRange) { const d=refRange.end-refRange.start; return {start:new Date(refRange.start-d),end:new Date(refRange.start)}; }
    switch(filter) {
        case 'today':     return {start:today, end:now};
        case 'yesterday': const y=new Date(today); y.setDate(y.getDate()-1); return {start:y,end:today};
        case '7days':     const w=new Date(today); w.setDate(w.getDate()-7); return {start:w,end:now};
        case '30days':    const mo=new Date(today); mo.setDate(mo.getDate()-30); return {start:mo,end:now};
        default:          return {start:new Date(0),end:now};
    }
}

function getStatusText(s) {
    if (s.events?.checkout)      return 'üí≥ CLIC√ì EN CHECKOUT';
    if (s.events?.offer_viewed)  return 'üéØ Viendo Oferta';
    if (s.events?.result_shown)  return 'üéâ Vio Resultado Personalizado';
    if (s.events?.quiz_completed)return '‚úÖ Complet√≥ Quiz (8/8)';
    if (s.events?.quiz_started)  return `üìù Respondiendo Quiz (${s.quizProgress||1}/8)`;
    return 'üì± Viendo P√°gina';
}

// ‚îÄ‚îÄ QUIZ PROGRESS DOTS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function quizDotsHTML(s) {
    if (!s.events?.quiz_started) return '';
    const done = Math.min(s.quizProgress||0, 8);
    const completed = !!s.events?.quiz_completed;
    let dots='';
    for(let i=0;i<8;i++){
        let cls='qp-dot';
        if(i<done) cls+=' done';
        else if(i===done && !completed) cls+=' current';
        dots+=`<div class="${cls}"></div>`;
    }
    const label = completed ? '8/8 ‚úì' : `${done}/8`;
    return `<div class="quiz-progress-dots">${dots}<span class="qp-label">${label}</span></div>`;
}

// ‚îÄ‚îÄ SONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function playCheckoutSound() {
    try {
        const ac=new (window.AudioContext||window.webkitAudioContext)();
        const now=ac.currentTime;
        [800,1200,1600,2000].forEach(freq=>{
            const o=ac.createOscillator(),g=ac.createGain();
            o.connect(g); g.connect(ac.destination);
            o.frequency.value=freq; o.type='sine';
            g.gain.setValueAtTime(0.2,now); g.gain.exponentialRampToValueAtTime(0.01,now+0.8);
            o.start(now); o.stop(now+0.8);
        });
    } catch(e){}
}
function playSaleSound() {
    try {
        const ac=new (window.AudioContext||window.webkitAudioContext)();
        const now=ac.currentTime;
        [{f:523.25,t:0},{f:659.25,t:0.15},{f:783.99,t:0.3},{f:1046.5,t:0.45}].forEach(n=>{
            const o=ac.createOscillator(),g=ac.createGain();
            o.connect(g); g.connect(ac.destination);
            o.frequency.value=n.f; o.type='triangle';
            const st=now+n.t;
            g.gain.setValueAtTime(0.3,st); g.gain.exponentialRampToValueAtTime(0.01,st+0.3);
            o.start(st); o.stop(st+0.3);
        });
    } catch(e){}
}

// ‚îÄ‚îÄ ALERTAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showAlert(type,title,msg) {
    const c=document.getElementById('alerts-container');
    const id='alert_'+Date.now();
    const d=document.createElement('div');
    d.id=id; d.className=`alert-item ${type}`;
    d.innerHTML=`<span class="alert-close" onclick="closeAlert('${id}')">√ó</span><div class="alert-title">${title}</div><div class="alert-message">${msg}</div>`;
    c.appendChild(d);
    setTimeout(()=>closeAlert(id),5000);
}
window.closeAlert=function(id){ const a=document.getElementById(id); if(a){a.style.animation='fadeOut 0.3s ease'; setTimeout(()=>a.remove(),300);} };

// ‚îÄ‚îÄ COMPARA√á√ÉO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.updateComparison=function(){
    const pA=document.getElementById('period-a').value;
    const pB=document.getElementById('period-b').value;
    const rA=getDateRange(pA);
    const rB=getDateRange(pB,rA);
    renderComparison(calcPeriodStats(rA), calcPeriodStats(rB), pA, pB);
};

function calcPeriodStats(range) {
    const ss=allSessions.filter(s=>{
        if(!s.enteredAt) return false;
        const d=s.enteredAt.toDate?s.enteredAt.toDate():new Date(s.enteredAt);
        return d>=range.start && d<=range.end;
    });
    const sl=allSales.filter(s=>{
        if(!s.createdAt||s.isPaid!==true) return false;
        const d=s.createdAt.toDate?s.createdAt.toDate():new Date(s.createdAt);
        return d>=range.start && d<=range.end;
    });
    const gross=sl.reduce((a,s)=>a+(s.amount||0),0);
    const fees=gross*0.15;
    const net=gross-fees;
    return {
        acessos:ss.length,
        iniciouQuiz:ss.filter(s=>s.events?.quiz_started).length,
        completouQuiz:ss.filter(s=>s.events?.quiz_completed).length,
        viuResultado:ss.filter(s=>s.events?.result_shown).length,
        checkout:ss.filter(s=>s.events?.checkout).length,
        vendas:sl.length,
        faturamentoBruto:gross, taxas:fees, faturamento:net,
        conversao:ss.length>0?(sl.length/ss.length)*100:0,
        ticketMedio:sl.length>0?net/sl.length:0
    };
}

function renderComparison(sA,sB,pA,pB){
    const names={today:'Hoy',yesterday:'Ayer','7days':'√öltimos 7d','30days':'√öltimos 30d',prev_period:'Per√≠odo Anterior'};
    const isWinA=sA.conversao>=sB.conversao;
    const row=(lbl,vA,vB,fmt=false,rev=false)=>{
        const nA=fmt?parseFloat(vA.toString().replace(/[^\d.-]/g,'')):vA;
        const nB=typeof vB==='number'?vB:parseFloat(vB.toString().replace(/[^\d.-]/g,''));
        let diff=(nA-nB)*(rev?-1:1), dp=nB!==0?((diff/nB)*100):0;
        const cls=diff>0?'positive':'negative', arrow=diff>0?'‚Üë':'‚Üì';
        return `<div class="comparison-row"><div><div class="comparison-label">${lbl}</div><div class="comparison-value">${vA}</div></div>${nB!==0?`<div class="comparison-diff ${cls}">${arrow} ${Math.abs(dp).toFixed(1)}%</div>`:''}</div>`;
    };
    const renderCard=(stats,ref,period,isWinner)=>`
        <div class="comparison-card ${isWinner?'winner':'loser'}">
            <div class="comparison-header">
                <div class="comparison-period">${names[period]}</div>
                <div class="comparison-badge ${isWinner?'up':'down'}">${isWinner?'üèÜ MEJOR':'üìâ MENOR'}</div>
            </div>
            <div class="comparison-stats">
                ${row('Accesos',stats.acessos,ref.acessos)}
                ${row('Inici√≥ Quiz',stats.iniciouQuiz,ref.iniciouQuiz)}
                ${row('Complet√≥ Quiz',stats.completouQuiz,ref.completouQuiz)}
                ${row('Vio Resultado',stats.viuResultado,ref.viuResultado)}
                ${row('Checkout',stats.checkout,ref.checkout)}
                ${row('Ventas',stats.vendas,ref.vendas)}
                ${row('Bruto',fmt$(stats.faturamentoBruto),ref.faturamentoBruto,true)}
                ${row('Tasas',fmt$(stats.taxas),ref.taxas,true)}
                ${row('Neto',fmt$(stats.faturamento),ref.faturamento,true)}
                ${row('Conversi√≥n',stats.conversao.toFixed(1)+'%',ref.conversao,true)}
                ${row('Ticket Promedio',fmt$(stats.ticketMedio),ref.ticketMedio,true)}
            </div>
        </div>`;
    document.getElementById('comparison-grid').innerHTML = renderCard(sA,sB,pA,isWinA)+renderCard(sB,sA,pB,!isWinA);
}

// ‚îÄ‚îÄ FILTRO DE DATAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.setDateFilter=function(filter,evt){
    currentDateFilter=filter; customDateRange=null;
    document.querySelectorAll('.compact-filter-btn').forEach(b=>b.classList.remove('active'));
    if(evt) evt.target.classList.add('active');
    updateSalesStats(); updateSalesTimeChart(); updateFunnel();
};
window.setCustomDateRange=function(){
    const s=document.getElementById('date-start').value, e=document.getElementById('date-end').value;
    if(!s||!e){alert('Selecione ambas as datas!');return;}
    const start=new Date(s); start.setHours(0,0,0,0);
    const end=new Date(e); end.setHours(23,59,59,999);
    if(start>end){alert('Data inicial maior que final!');return;}
    customDateRange={start,end}; currentDateFilter='custom';
    document.querySelectorAll('.compact-filter-btn').forEach(b=>b.classList.remove('active'));
    updateSalesStats(); updateSalesTimeChart(); updateFunnel();
};

// ‚îÄ‚îÄ STATS PRINCIPAIS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateStats() {
    const total=allSessions.length;
    const online=allSessions.filter(s=>isOnline(s)).length;
    const iniciouQuiz=allSessions.filter(s=>s.events?.quiz_started).length;
    const completouQuiz=allSessions.filter(s=>s.events?.quiz_completed).length;
    const viuResultado=allSessions.filter(s=>s.events?.result_shown).length;
    const clickedCheckout=allSessions.filter(s=>s.events?.checkout).length;

    // Detectar novos checkouts
    allSessions.forEach(s=>{
        if(s.events?.checkout && !lastCheckoutIds.has(s.id)){
            lastCheckoutIds.add(s.id);
            playCheckoutSound();
            const sid=(s.sessionId||s.id).slice(-6).toUpperCase();
            showAlert('checkout','üí≥ NUEVO CHECKOUT!',`Lead #${sid} est√° en el checkout ahora!`);
        }
    });

    document.getElementById('online-now').textContent=online;
    document.getElementById('total-visits').textContent=total;
    document.getElementById('passed-instruction').textContent=iniciouQuiz;
    document.getElementById('clicked-vsl').textContent=completouQuiz;
    document.getElementById('started-quiz').textContent=viuResultado;
    document.getElementById('total-leads').textContent=completouQuiz;
    document.getElementById('checkout-count').textContent=clickedCheckout;
    document.getElementById('passed-instruction-pct').textContent=pct(iniciouQuiz,total);
    document.getElementById('clicked-vsl-pct').textContent=pct(completouQuiz,total);
    document.getElementById('started-quiz-pct').textContent=pct(viuResultado,total);
    document.getElementById('checkout-pct').textContent=pct(clickedCheckout,total);
    document.getElementById('completion-rate').textContent=pct(completouQuiz,iniciouQuiz);

    const dropouts={'Gancho':total-iniciouQuiz,'Quiz':iniciouQuiz-completouQuiz,'An√°lisis':completouQuiz-viuResultado,'Checkout':viuResultado-clickedCheckout};
    const max=Object.entries(dropouts).reduce((m,[k,v])=>v>m.val?{stage:k,val:v}:m,{stage:'--',val:0});
    document.getElementById('highest-dropout').textContent=max.val>0?max.stage:'--';

    updatePeakHourChart();
    updateQuizRetention();
}

// ‚îÄ‚îÄ VENTAS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateSalesStats() {
    const range=getDateRange(currentDateFilter);
    const filtered=allSales.filter(s=>{
        if(!s.createdAt||s.isPaid!==true) return false;
        const d=s.createdAt.toDate?s.createdAt.toDate():new Date(s.createdAt);
        return d>=range.start && d<=range.end;
    });

    // Novas vendas hoje
    const today=new Date(); today.setHours(0,0,0,0);
    allSales.filter(s=>{
        if(!s.createdAt||s.isPaid!==true) return false;
        const d=s.createdAt.toDate?s.createdAt.toDate():new Date(s.createdAt);
        return d>=today;
    }).forEach(s=>{
        if(!lastSaleIds.has(s.transactionId||s.id)){
            lastSaleIds.add(s.transactionId||s.id);
            playSaleSound();
            const gross=s.amount||0, net=calcNet(gross);
            showAlert('sale','üí∞ ¬°NUEVA VENTA!',`Bruto: ${fmt$(gross)} | Neto: ${fmt$(net)} üéâ`);
        }
    });

    const count=filtered.length;
    const gross=filtered.reduce((a,s)=>a+(s.amount||0),0);
    const fees=gross*0.15, net=gross-fees;
    const visits=allSessions.filter(s=>{
        if(!s.enteredAt) return false;
        const d=s.enteredAt.toDate?s.enteredAt.toDate():new Date(s.enteredAt);
        return d>=range.start && d<=range.end;
    }).length;
    const checkouts=allSessions.filter(s=>{
        if(!s.enteredAt) return false;
        const d=s.enteredAt.toDate?s.enteredAt.toDate():new Date(s.enteredAt);
        return s.events?.checkout && d>=range.start && d<=range.end;
    }).length;

    document.getElementById('sales-today').textContent=count;
    document.getElementById('revenue-today').textContent=fmt$(gross);
    document.getElementById('total-fees').textContent='-'+fmt$(fees);
    document.getElementById('net-revenue').textContent=fmt$(net);
    document.getElementById('conversion-rate').textContent=visits>0?((count/visits)*100).toFixed(1)+'%':'0%';
    document.getElementById('average-ticket').textContent=fmt$(count>0?net/count:0);
    document.getElementById('leads-per-sale').textContent=count>0?Math.round(checkouts/count):'--';

    updateSalesTimeChart();
    updateHeatmap();
    updateCountries();
}

// ‚îÄ‚îÄ GR√ÅFICO VENDAS AO LONGO DO TEMPO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateSalesTimeChart() {
    const range=getDateRange(currentDateFilter);
    const byDay={};
    allSales.forEach(s=>{
        if(!s.createdAt||s.isPaid!==true) return;
        const d=s.createdAt.toDate?s.createdAt.toDate():new Date(s.createdAt);
        if(d>=range.start&&d<=range.end){ const k=d.toLocaleDateString('es-ES'); byDay[k]=(byDay[k]||0)+1; }
    });
    const days=[], counts=[];
    const cur=new Date(range.start), end=new Date(range.end);
    while(cur<=end){ const k=cur.toLocaleDateString('es-ES'); days.push(k); counts.push(byDay[k]||0); cur.setDate(cur.getDate()+1); }

    const ctx=document.getElementById('salesTimeChart');
    if(!ctx) return;
    if(salesTimeChart) salesTimeChart.destroy();
    salesTimeChart=new Chart(ctx.getContext('2d'),{
        type:'line',
        data:{ labels:days, datasets:[{label:'Ventas',data:counts,borderColor:'#00e5a0',backgroundColor:'rgba(0,229,160,0.1)',borderWidth:3,fill:true,tension:0.4,pointRadius:5,pointBackgroundColor:'#00e5a0',pointBorderColor:'#fff',pointBorderWidth:2,pointHoverRadius:7}]},
        options:{ responsive:true, maintainAspectRatio:false,
            plugins:{legend:{labels:{color:'#fff',font:{size:12,weight:'bold'}}}},
            scales:{
                x:{grid:{color:'rgba(26,107,255,0.1)'},ticks:{color:'#999',font:{size:10},maxRotation:45,minRotation:45,maxTicksLimit:15}},
                y:{beginAtZero:true,grid:{color:'rgba(26,107,255,0.1)'},ticks:{color:'#999',font:{size:10},stepSize:1}}
            }
        }
    });
}

// ‚îÄ‚îÄ FUNIL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateFunnel() {
    const total=allSessions.length;
    const iniciouQuiz=allSessions.filter(s=>s.events?.quiz_started).length;
    const completouQuiz=allSessions.filter(s=>s.events?.quiz_completed).length;
    const viuResultado=allSessions.filter(s=>s.events?.result_shown).length;
    const oferta=allSessions.filter(s=>s.events?.offer_viewed).length;
    const checkout=allSessions.filter(s=>s.events?.checkout).length;
    const sales=allSales.filter(s=>s.isPaid===true).length;
    const stages=[
        {name:'Total Accesos',count:total,pct:100},
        {name:'Inici√≥ Quiz',count:iniciouQuiz,pct:total>0?(iniciouQuiz/total)*100:0},
        {name:'Complet√≥ Quiz',count:completouQuiz,pct:total>0?(completouQuiz/total)*100:0},
        {name:'Vio Resultado',count:viuResultado,pct:total>0?(viuResultado/total)*100:0},
        {name:'Visualiz√≥ Oferta',count:oferta,pct:total>0?(oferta/total)*100:0},
        {name:'Clic√≥ Checkout',count:checkout,pct:total>0?(checkout/total)*100:0},
        {name:'üí∞ VENTAS',count:sales,pct:total>0?(sales/total)*100:0}
    ];
    document.getElementById('funnel-container').innerHTML=stages.map((s,i)=>`
        <div class="funnel-stage">
            <div class="funnel-stage-header">
                <div class="funnel-stage-name">${s.name}</div>
                <div class="funnel-stage-count">${s.count}</div>
            </div>
            <div class="funnel-stage-bar"><div class="funnel-stage-fill" style="width:${s.pct}%"></div></div>
            <div class="funnel-stage-percent">${s.pct.toFixed(1)}% do total</div>
        </div>
        ${i<stages.length-1?'<div class="funnel-arrow">‚Üì</div>':''}
    `).join('');
}

// ‚îÄ‚îÄ HEATMAP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateHeatmap() {
    const days=['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'];
    const hours=['00h','04h','08h','12h','16h','20h'];
    const data={};
    days.forEach(d=>{data[d]={}; hours.forEach(h=>{data[d][h]=0;});});
    allSales.forEach(s=>{
        if(!s.createdAt||s.isPaid!==true) return;
        const d=s.createdAt.toDate?s.createdAt.toDate():new Date(s.createdAt);
        const day=days[d.getDay()], h=d.getHours();
        const slot=h<4?'00h':h<8?'04h':h<12?'08h':h<16?'12h':h<20?'16h':'20h';
        data[day][slot]++;
    });
    let max=0;
    Object.values(data).forEach(d=>Object.values(d).forEach(v=>{if(v>max)max=v;}));
    let html='<table class="heatmap-table"><thead><tr><th>D√≠a</th>';
    hours.forEach(h=>html+=`<th>${h}</th>`);
    html+='</tr></thead><tbody>';
    days.forEach(day=>{
        html+=`<tr><td class="day-label">${day}</td>`;
        hours.forEach(h=>{
            const c=data[day][h];
            let cls='empty';
            if(max>0&&c>0){ const p=(c/max)*100; cls=p>=70?'high':p>=30?'medium':'low'; }
            html+=`<td class="heatmap-cell ${cls}" title="${day} ${h}: ${c} ventas">${c}</td>`;
        });
        html+='</tr>';
    });
    html+='</tbody></table><div class="heatmap-legend"><div class="heatmap-legend-item"><div class="heatmap-legend-color" style="background:rgba(0,229,160,0.6)"></div><span>üü¢ Alto (70%+)</span></div><div class="heatmap-legend-item"><div class="heatmap-legend-color" style="background:rgba(255,201,64,0.6)"></div><span>üü° Medio (30-70%)</span></div><div class="heatmap-legend-item"><div class="heatmap-legend-color" style="background:rgba(255,64,96,0.6)"></div><span>üî¥ Bajo (&lt;30%)</span></div></div>';
    document.getElementById('heatmap-container').innerHTML=html;
}

// ‚îÄ‚îÄ CHART PICO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updatePeakHourChart() {
    const byHour={};
    allSessions.forEach(s=>{
        if(!s.enteredAt) return;
        const d=s.enteredAt.toDate?s.enteredAt.toDate():new Date(s.enteredAt);
        const h=d.getHours();
        if(!byHour[h]) byHour[h]=new Set();
        byHour[h].add(s.sessionId||s.id);
    });
    const labels=[], data=[];
    for(let i=0;i<24;i++){ labels.push(i.toString().padStart(2,'0')+'h'); data.push(byHour[i]?byHour[i].size:0); }
    const ctx=document.getElementById('peakHourChart').getContext('2d');
    if(peakHourChart) peakHourChart.destroy();
    peakHourChart=new Chart(ctx,{
        type:'line',
        data:{labels,datasets:[{label:'Visitantes',data,borderColor:'#1a6bff',backgroundColor:'rgba(26,107,255,0.1)',borderWidth:3,fill:true,tension:0.4,pointRadius:4,pointBackgroundColor:'#1a6bff',pointBorderColor:'#fff',pointBorderWidth:2,pointHoverRadius:6,pointHoverBackgroundColor:'#00e5a0'}]},
        options:{responsive:true,maintainAspectRatio:false,
            plugins:{legend:{labels:{color:'#fff',font:{size:12,weight:'bold'}}}},
            scales:{
                x:{grid:{color:'rgba(26,107,255,0.1)'},ticks:{color:'#999',font:{size:10},maxRotation:45,minRotation:45}},
                y:{beginAtZero:true,grid:{color:'rgba(26,107,255,0.1)'},ticks:{color:'#999',font:{size:10},stepSize:1}}
            }
        }
    });
}

// ‚îÄ‚îÄ QUIZ RETENTION ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateQuizRetention() {
    const qNames=['Tama√±o','Duraci√≥n','Satisfacci√≥n','Edad','Alimentaci√≥n','Sue√±o','Ya Prob√≥','Prioridad'];
    const qProgress={};
    for(let i=1;i<=8;i++) qProgress[i]=0;
    allSessions.forEach(s=>{ const p=s.quizProgress||0; for(let i=1;i<=p;i++) qProgress[i]++; });
    const total=allSessions.filter(s=>s.events?.quiz_started).length;
    if(!total){ document.getElementById('quiz-stats').innerHTML='<div class="empty-state">Esperando datos del quiz...</div>'; return; }
    document.getElementById('quiz-stats').innerHTML=Array.from({length:8},(_,i)=>{
        const n=qProgress[i+1], p=total>0?Math.round((n/total)*100):0;
        return `<div class="quiz-row"><div class="quiz-step">Q${i+1}: ${qNames[i]}</div><div class="quiz-count">${n} (${p}%)</div></div>`;
    }).join('');
}

// ‚îÄ‚îÄ PA√çSES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateCountries() {
    const codes=['MX','CO','AR','PE','CL','OTHER'];
    const names={MX:'M√©xico',CO:'Colombia',AR:'Argentina',PE:'Per√∫',CL:'Chile',OTHER:'Otros'};
    const data={}; codes.forEach(c=>data[c]={visits:0,sales:0,revenue:0});
    allSessions.forEach(s=>{ const c=data[s.country]?s.country:'OTHER'; data[c].visits++; });
    allSales.forEach(s=>{ const c=data[s.country]?s.country:'OTHER'; data[c].sales++; data[c].revenue+=s.amount||0; });
    const maxV=Math.max(...codes.map(c=>data[c].visits),1);
    document.getElementById('countries-grid').innerHTML=codes.map(code=>{
        const d=data[code];
        const conv=d.visits>0?((d.sales/d.visits)*100).toFixed(1)+'%':'0%';
        const isHot=d.visits===maxV&&d.visits>0;
        return `<div class="country-pill${isHot?' hottest':''}">
            <div class="country-flag">${code==='OTHER'?'üåé':getFlag(code)}</div>
            <div class="country-data">
                <div class="country-name">${names[code]}</div>
                <div class="country-nums"><span class="country-vis">${d.visits}</span><span class="country-conv">${conv}</span><span class="country-rev">${fmt$(d.revenue)}</span></div>
            </div>
        </div>`;
    }).join('');
}

// ‚îÄ‚îÄ SPY FEED ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.filterSpy=function(filter,evt){
    spyFilter=filter;
    document.querySelectorAll('.spy-filter-btn').forEach(b=>b.classList.remove('active'));
    if(evt) evt.target.classList.add('active');
    updateSpyFeed();
};

function updateSpyFeed() {
    const container=document.getElementById('spy-container');
    const sorted=[...allSessions].sort((a,b)=>ms(b.lastActivity)-ms(a.lastActivity));
    const unique=[], seen=new Set();
    for(const s of sorted){ const id=s.sessionId||s.id; if(!seen.has(id)){seen.add(id);unique.push(s);} }

    let filtered=unique;
    if(spyFilter==='online') filtered=unique.filter(s=>isOnline(s));
    else if(spyFilter==='checkout') filtered=unique.filter(s=>s.events?.checkout);
    else if(spyFilter==='sale') filtered=unique.filter(s=>{ const id=s.sessionId||s.id; return allSales.some(x=>x.isPaid===true&&(x.sessionId===id||x.externalId===id)); });

    const list=filtered.slice(0,50);
    if(!list.length){ container.innerHTML='<div class="empty-state"><div style="font-size:48px;margin-bottom:15px;">üîç</div><div style="color:#999;">Ning√∫n lead encontrado</div></div>'; return; }

    container.innerHTML=list.map(s=>{
        const online=isOnline(s);
        const sid=s.sessionId||s.id;
        const shortId=sid.slice(-6).toUpperCase();
        const isCheckout=s.events?.checkout;
        const sale=allSales.find(x=>x.isPaid===true&&(x.sessionId===sid||x.externalId===sid));
        const hasSale=!!sale;
        const netAmt=hasSale?calcNet(sale.amount||0):0;
        const statusText=hasSale?'üí∞ ¬°COMPR√ì!':getStatusText(s);
        let itemCls='spy-item', statusCls='spy-status';
        if(hasSale){itemCls+=' sale'; statusCls+=' sale';}
        else if(isCheckout){itemCls+=' checkout'; statusCls+=' checkout';}
        return `
        <div class="${itemCls}">
            <div class="spy-avatar">${shortId.charAt(0)}</div>
            <div class="spy-content">
                <div class="spy-header">
                    <div class="spy-id">Lead #${shortId} ${getFlag(s.country)}</div>
                    <div class="spy-time">${timeAgo(s.enteredAt)}</div>
                </div>
                <div class="${statusCls}">${statusText}</div>
                ${quizDotsHTML(s)}
            </div>
            <div class="spy-badges">
                ${online&&!hasSale?'<div class="online-dot"></div>':''}
                ${isCheckout&&!hasSale?'<div class="checkout-badge">CHECKOUT</div>':''}
                ${hasSale?`<div class="sale-badge">${fmt$(netAmt)}</div>`:''}
            </div>
        </div>`;
    }).join('');
}

// ‚îÄ‚îÄ FIREBASE LISTENERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
onSnapshot(query(collection(db,'sessions'),orderBy('enteredAt','desc')),snap=>{
    allSessions=snap.docs.map(d=>({id:d.id,...d.data()}))
        .filter(s=>s.source==='tiktok_latam'||s.source==='latam');
    updateStats(); updateFunnel(); updateSpyFeed(); updateComparison();
});
onSnapshot(query(collection(db,'sales'),orderBy('createdAt','desc')),snap=>{
    allSales=snap.docs.map(d=>({id:d.id,...d.data()}))
        .filter(s=>(s.source==='latam'||s.source==='tiktok_latam')&&s.isPaid===true);
    updateSalesStats(); updateFunnel(); updateSpyFeed();
});

// Auto-refresh a cada 30s
setInterval(()=>{ updateStats(); updateSpyFeed(); updateSalesStats(); },30000);

// Init
updatePeakHourChart(); updateFunnel(); updateHeatmap(); updateComparison();
</script>
</body>
</html>
